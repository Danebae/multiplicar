<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Prueba de Cálculo Mental</title>
	<style>
		body {
			font-family: Arial, sans-serif;
			text-align: center;
			margin-top: 50px;
			line-height: 2;
		}

		h1 {
			font-size: 2.5em;
			margin-bottom: 20px;
		}

		#score,
		#timer,
		#problem,
		#result {
			font-size: 2em;
			margin-bottom: 20px;
		}

		input {
			padding: 15px;
			font-size: 1.5em;
			margin-bottom: 20px;
			width: 50%;
		}

		button,
		select {
			padding: 15px 30px;
			font-size: 1.5em;
			cursor: pointer;
			margin: 5px;
			width: 250px;
		}

		select {
			width: 500px;
		}

		#container {
			margin-top: 20px;
			display: none;
			flex-direction: column;
			align-items: center;
		}

		#records {
			font-size: 1.5em;
			margin-top: 20px;
			text-align: left;
			display: inline-block;
		}

		#session {
			position: absolute;
			bottom: 20px;
			left: 20px;
			font-weight: bold;
		}

		#info {
			position: absolute;
			bottom: 20px;
			right: 20px;
		}

		#session {
			position: absolute;
			bottom: 20px;
			left: 20px;
			font-size: 1.5em;
			font-weight: bold;
		}

		#totalTimeContainer {
			position: absolute;
			top: 20px;
			left: 20px;
			font-size: 1.5em;
			text-align: left;
		}

		#selected,
		#bestTime {
			font-weight: bold;
		}

		#totalTime {
			color: red;
		}
	</style>
</head>

<body>
	<h1>Prueba de Cálculo Mental</h1>
	<div id="startOptions">
		<select id="tipoElegido" onchange="loadRecords()">
			<option selected disabled> --- </option>
			<option value="M">Multiplicar</option>
			<option value="D">Dividir</option>
			<option value="MR">Multiplicar y Restar</option>
			<option value="DS">Dividir y Sumar</option>
		</select><br>
		<button disabled onclick="selectOption(50, false)">50 Puntos</button>
		<button disabled onclick="selectOption(100, false)">100 Puntos</button>
		<button disabled onclick="selectOption(200, false)">200 Puntos</button><br>
		<button disabled onclick="selectOption(50, true)">50 Puntos Difícil</button>
		<button disabled onclick="selectOption(100, true)">100 Puntos Difícil</button>
		<button disabled onclick="selectOption(200, true)">200 Puntos Difícil</button><br>
	</div>
	<div id="container" style="display: none;">
		<div id="score">Puntuación: 0</div>
		<div id="timer">Tiempo: 0.0 s</div>
		<div id="problem"></div>
		<input type="number" id="answer" placeholder="Tu respuesta" onkeypress="handleEnter(event)" disabled>
		<div id="result"></div>
		<button id="nextButton" style="display: none;" onclick="generateProblem()">Siguiente</button>
	</div>
	<div id="records">
		<div>Mejor Tiempo 50 Puntos: <span id="record50">--</span></div>
		<div>Mejor Tiempo 100 Puntos: <span id="record100">--</span></div>
		<div>Mejor Tiempo 200 Puntos: <span id="record200">--</span></div>
		<div>Mejor Tiempo 50 Puntos Difícil: <span id="record50_d">--</span></div>
		<div>Mejor Tiempo 100 Puntos Difícil: <span id="record100_d">--</span></div>
		<div>Mejor Tiempo 200 Puntos Difícil: <span id="record200_d">--</span></div>
	</div>
	<div id="session"></div>
	<div id="info">
		<label>Created by Jon Bilbao</label><br>
		<label>Betatester Aitor Bilbao</label>
	</div>
	<div id="totalTimeContainer">
		<div id="selected"></div>
		<div id="infoDoble"></div>
		<div id="infoNormal"></div>
		<div id="infoMaxTime"></div><br>
		<div id="totalTime"></div>
		<div id="bestTime"></div>
	</div>
	<script>
		let num1, num2, correctAnswer;
		let intentos = 0;
		let timerInterval, totalTimerInterval;
		let timer = 0;
		let totalTimer = 0;
		let score = 0;
		let gameStarted = false;
		let targetScore = 0;
		let isDifficult = false;
		let doublePointThreshold, pointThreshold, maxResponseTime;
		let repitiendo = false;
		let inicio;
		function loadRecords() {
			document.querySelectorAll("button").forEach(button => {
				button.disabled = false;
			});
			['50', '100', '200', '50_d', '100_d', '200_d'].forEach((key, i) => {
				const preKey = document.getElementById("tipoElegido").value;
				const record = localStorage.getItem(`${preKey}_${key}`);
				document.getElementById(`record${key}`).innerText = record ? `${record} s` : '--';
			});
		}
		loadRecords();
		function generateSessionId() {
			const characters = "ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";
			let result = "";
			for (let i = 0; i < 5; i++) {
				result += characters.charAt(Math.floor(Math.random() * characters.length));
			}
			return result;
		}
		const sessionId = generateSessionId();
		document.getElementById("session").innerText = `Sesión: ${sessionId}`;
		function selectOption(target, difficult) {
			const nivel = difficult
				? "dificil"
				: "facil";
			targetScore = target;
			isDifficult = difficult;
			doublePointThreshold = difficult ? 2 : 3;
			pointThreshold = doublePointThreshold * 2;
			maxResponseTime = doublePointThreshold * 3;
			document.getElementById("selected").innerHTML = `Seleccionado: ${target} puntos ${nivel}.`;
			document.getElementById("infoDoble").innerHTML = `Punto doble: ${doublePointThreshold}s.`
			document.getElementById("infoNormal").innerHTML = `Punto normal: ${pointThreshold}s.`
			document.getElementById("infoMaxTime").innerHTML = `Tiempo máx: ${maxResponseTime}s.`
			document.getElementById("startOptions").style.display = "none";
			document.getElementById("records").style.display = "none";
			document.getElementById("container").style.display = "block";
			// Mostrar el mejor tiempo para la opción seleccionada
			const key = `${target}${difficult ? '_d' : ''}`;
			const bestTime = parseFloat(localStorage.getItem(`bestTime_${key}`)) || null;
			document.getElementById("bestTime").innerText = bestTime
				? `Mejor tiempo: ${bestTime.toFixed(1)} s`
				: "Mejor tiempo: --";
			startTotalTimer(); // Iniciar el cronómetro total
			generateProblem();
		}
		function generateProblem() {
			intentos++;
			clearInterval(timerInterval);
			document.getElementById("timer").innerText = `Tiempo: 0.0 s`;
			document.getElementById("problem").innerText = "";
			document.getElementById("result").innerText = "";
			document.getElementById("nextButton").style.display = "none";
			document.getElementById("answer").value = "";
			document.getElementById("answer").disabled = false;
			num1 = Math.floor(Math.random() * (9 - 3 + 1)) + 3; // Número entre 3 y 9
			num2 = Math.floor(Math.random() * (9 - 4 + 1)) + 4; // Número entre 4 y 9
			num3 = Math.floor(Math.random() * (9 - 5 + 1)) + 5; // Número entre 5 y 9
			if (document.getElementById("tipoElegido").selectedIndex === 0) {
				correctAnswer = num1 * num2;
				document.getElementById("problem").innerText = `${num1} x ${num2} = ?`;
			} else if (document.getElementById("tipoElegido").selectedIndex === 1) {
				correctAnswer = num1 * num2 + num3;
				document.getElementById("problem").innerText = `( ${num1} x ${num2} ) + ${num3} = ?`;
			}
			document.getElementById("answer").focus();
			startTimer();
		}
		function startTimer() {
			timer = 0.0;
			inicio = Date.now();
			repitiendo = false;
			timerInterval = setInterval(() => {
				timer = ((Date.now()-inicio) / 100) / 10.0;
				document.getElementById("timer").innerText = `Tiempo: ${timer.toFixed(1)} s`;
				if (timer >= maxResponseTime) {
					clearInterval(timerInterval);
					handleTimeout();
					document.getElementById("timer").innerText = `Tiempo: ${maxResponseTime.toFixed(1)} s`;
				}
			}, 100);
		}
		function startTotalTimer() {
			gameStarted = true;
			totalTimerInterval = setInterval(() => {
				totalTimer += 0.1;
				document.getElementById("totalTime").innerText = `Tiempo total: ${totalTimer.toFixed(1)} s`;
			}, 100);
		}
		function stopTotalTimer() {
			clearInterval(totalTimerInterval);
			gameStarted = false;
			const key = `${targetScore}${isDifficult ? '_d' : ''}`;
			const previousBest = parseFloat(localStorage.getItem(`bestTime_${key}`)) || Infinity;
			document.getElementById("score").innerText = `Puntuación: ${score} puntos en ${intentos} intentos.`;
			if (totalTimer < previousBest) {
				localStorage.setItem(`bestTime_${key}`, totalTimer.toFixed(1));
				document.getElementById("bestTime").innerText = `Mejor tiempo: ${totalTimer.toFixed(1)} s`;
				alert(`¡Nuevo récord! Terminaste en ${totalTimer.toFixed(1)} segundos.`);
			} else {
				alert(`Terminaste en ${totalTimer.toFixed(1)} segundos. Tu récord es ${previousBest.toFixed(1)} segundos.`);
			}
		}
		function handleTimeout() {
			const resultElement = document.getElementById("result");
			if (isDifficult) {
				resultElement.innerText = `Tiempo agotado. Introduce la respuesta correcta para continuar.`;
				document.getElementById("timer").focus();
			} else {
				resultElement.innerText = `Tiempo agotado. La respuesta correcta era ${correctAnswer}.`;
			}
			resultElement.style.color = "red";
			if (!repitiendo) updateScore(-1);
			repite();
		}
		function handleEnter(event) {
			if (event.key === "Enter") {
				clearInterval(timerInterval);
				const userAnswer = parseInt(document.getElementById("answer").value);
				const resultElement = document.getElementById("result");
				if (userAnswer === correctAnswer) {
					resultElement.style.color = "green";
					if (!repitiendo) {
						if (timer <= doublePointThreshold) {
							updateScore(2);
							resultElement.innerText = "¡Correcto! Has ganado 2 puntos.";
						} else if (timer <= pointThreshold) {
							updateScore(1);
							resultElement.innerText = "¡Correcto! Has ganado 1 punto.";
						} else {
							resultElement.innerText = "¡Correcto!";
						}
					} else {
						resultElement.innerText = "¡Correcto!";
					}
					if (score < targetScore) siguiente();
				} else {

					if (isNaN(userAnswer)) {
						resultElement.innerText = `Incorrecto. Tu respuesta no era un numero. `;
					} else {
						resultElement.innerText = `Incorrecto. Tu respuesta fue: "${userAnswer}". `;
					}

					if (isDifficult) {
						resultElement.innerText += `Introduce la respuesta correcta para continuar.`;
					} else {
						resultElement.innerText = `La respuesta correcta era ${correctAnswer}.`;
					}

					resultElement.style.color = "red";
					if (isDifficult || !repitiendo) updateScore(-1);
					repite();
				}
			}
		}
		function repite() {
			repitiendo = true;
			document.getElementById("answer").value = "";
			if (isDifficult) {
				document.activeElement.blur();
			} else {
				document.getElementById("answer").focus();
			}
		}
		function siguiente() {
			document.getElementById("answer").disabled = true;
			document.getElementById("nextButton").style.display = "inline-block";
			document.getElementById("nextButton").focus();
		}

		function updateScore(points) {
			score += points;
			if (score < 0) score = 0;
			document.getElementById("score").innerText = `Puntuación: ${score}`;
			if (score >= targetScore) {
				stopTotalTimer();
			}
		}
	</script>
</body>

</html>